<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>推しカレンダーリスト</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

    <style>
        .sns-color { display:inline-block; width:12px; height:12px; border-radius:50%; margin:0 5px; vertical-align:middle; }
        .sns-label { margin-right:10px; }
        .fc-list-event { padding:4px 8px; border-radius:6px; margin-bottom:2px; }
        .fc-event-title { display: flex; align-items: center; }
        .fc-event img { width:40px; height:40px; margin-right:8px; border-radius:4px; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="header border-bottom">
        <h1 class="h2">推しカレンダーリスト</h1>
    </div>

    <div class="container my-3">
        <input type="text" id="search-keyword" class="form-control mb-2" placeholder="キーワードで検索">

        <div id="sns-filters" class="mb-3">
            <label><input type="checkbox" class="sns-filter" value="instagram" checked> Instagram</label>
            <label><input type="checkbox" class="sns-filter" value="tiktok" checked> TikTok</label>
            <label><input type="checkbox" class="sns-filter" value="youtube" checked> YouTube</label>
            <label><input type="checkbox" class="sns-filter" value="x" checked> X</label>
            <label><input type="checkbox" class="sns-filter" value="bitfanpublic" checked> Bitfan Public</label>
            <label><input type="checkbox" class="sns-filter" value="bitfanlimited" checked> Bitfan Limited</label>
        </div>
    </div>

    <div id="oshi-calendar-list" class="mb-4"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
    'use strict';
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('oshi-calendar-list');
        const searchInput = document.getElementById('search-keyword');
        const snsFiltersEl = document.getElementById('sns-filters');
        if (!calendarEl) return;

        const colorsBySNS = {
            instagram: { backgroundColor: 'deeppink', textColor: 'white', borderColor: 'deeppink' },
            tiktok: { backgroundColor: 'black', textColor: 'white', borderColor: 'black' },
            youtube: { backgroundColor: 'red', textColor: 'white', borderColor: 'red' },
            x: { backgroundColor: 'white', textColor: 'black', borderColor: 'black' },
            bitfanpublic: { backgroundColor: 'yellowgreen', textColor: 'black', borderColor: 'yellowgreen' },
            bitfanlimited: { backgroundColor: 'green', textColor: 'black', borderColor: 'green' },
            unknown: { backgroundColor: 'gray', textColor: 'white', borderColor: 'gray' }
        };

        // ★ チェックボックス横に色付き丸を追加
        snsFiltersEl.querySelectorAll("label").forEach(label => {
            const input = label.querySelector("input");
            const sns = input.value.toLowerCase();
            const color = colorsBySNS[sns]?.backgroundColor || "gray";

            const circle = document.createElement("span");
            circle.className = "sns-color";
            circle.style.backgroundColor = color;

            // input の直後に丸を挿入
            label.insertBefore(circle, input.nextSibling);
        });

        const apiList = [
            '/api/calendar/instagram',
            '/api/calendar/TikTok',
            '/api/calendar/YouTube',
            '/api/calendar/X',
            '/api/calendar/BitfanPublic',
            '/api/calendar/BitfanLimited'
        ];

        let allEvents = [];

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'listMonth',
            locale: 'ja',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'listWeek,listMonth' },
			views: {
			   listWeek: { buttonText: 'week' },
			   listMonth: { buttonText: 'month' }
			 },
			events: [],
            eventClick: function(info){
                if(info.event.url){ window.open(info.event.url, '_blank'); info.jsEvent.preventDefault(); }
            },
            eventDidMount: function(info){
                const color = info.event.extendedProps.colorProps;
                if(color){
                    info.el.style.backgroundColor = color.backgroundColor;
                    info.el.style.color = color.textColor;
                    info.el.style.borderColor = color.borderColor;
                }
            },
			eventContent: function(arg) {
			    const { image, sns } = arg.event.extendedProps;
			    const title = arg.event.title;
			    const url = arg.event.url;
			
			    const container = document.createElement('div');
			    container.style.display = 'flex';
			    container.style.alignItems = 'center';
			    container.style.cursor = 'pointer';
			    container.addEventListener('click', e => { if(url){ window.open(url, '_blank'); e.preventDefault(); } });
			
			    const circle = document.createElement('span');
			    circle.style.display = 'inline-block';
			    circle.style.width = '12px';
			    circle.style.height = '12px';
			    circle.style.borderRadius = '50%';
			    circle.style.marginRight = '8px';
			    circle.style.backgroundColor = colorsBySNS[sns]?.backgroundColor || 'gray';
			    container.appendChild(circle);
			
			    if(image){
			        const img = document.createElement('img');
			        img.src = image;
			        img.style.width = '40px';
			        img.style.height = '40px';
			        img.style.marginRight = '8px';
			        img.style.borderRadius = '4px';
			        container.appendChild(img);
			    }
			
			    const span = document.createElement('span');
			    span.textContent = title || '(タイトルなし)';
			    container.appendChild(span);
			
			    container.style.backgroundColor = colorsBySNS[sns]?.backgroundColor || 'gray';
			    container.style.color = colorsBySNS[sns]?.textColor || 'white';
			    container.style.border = `1px solid ${colorsBySNS[sns]?.borderColor || 'gray'}`;
			    container.style.padding = '2px 4px';
			    container.style.marginBottom = '2px';
			    container.style.borderRadius = '6px';
			
			    return { domNodes: [container] };
			}
        });

        calendar.render();

        function detectSNS(event){
            if(event.category){
                const cat = event.category.toLowerCase();
                if(cat === "bitfan_limited") return "bitfanlimited";
                if(cat === "bitfanpublic") return "bitfanpublic";
            }
            const url = (event.url || '').toLowerCase();
            if(url.includes('instagram.com')) return 'instagram';
            if(url.includes('tiktok.com')) return 'tiktok';
            if(url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
            if(url.includes('x.com') || url.includes('twitter.com')) return 'x';
            if(url.includes('bitfan.id')) return 'bitfanpublic';
            return 'unknown';
        }

        function formatStart(dateStr){
            if(!dateStr) return null;
            const match = dateStr.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2}) (\d{1,2}:\d{2})$/);
            if(match){
                const [ , y, m, d, hm ] = match;
                return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${hm}`;
            }
            return dateStr;
        }

        async function loadAllEvents(){
            allEvents = [];
            for(const api of apiList){
                try{
                    const res = await fetch(api);
                    if(!res.ok || !res.headers.get('content-type')?.includes('application/json')) continue;
                    const data = await res.json();
                    if(!Array.isArray(data)) continue;

                    data.forEach(event => {
                        const sns = detectSNS(event);
                        const color = colorsBySNS[sns] || colorsBySNS['unknown'];
                        const startISO = formatStart(event.start);
                        if(!startISO) return;

                        allEvents.push({
                            title: event.title,
                            start: startISO,
                            url: event.url || null,
                            image: event.image || null,
                            sns: sns,
                            colorProps: color
                        });
                    });
                }catch(err){ console.error(`API取得失敗: ${api}`, err); }
            }
            renderFilteredEvents();
        }

        function renderFilteredEvents(){
            const keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
            let checkedSNS = Array.from(document.querySelectorAll('#sns-filters input[type=checkbox]:checked'))
                                   .map(cb => cb.value.toLowerCase());
            if(checkedSNS.length === 0) checkedSNS = Object.keys(colorsBySNS);

            const filtered = allEvents.filter(e => 
                (!keyword || (e.title && e.title.toLowerCase().includes(keyword))) &&
                checkedSNS.includes(e.sns)
            );

            calendar.removeAllEvents();
            filtered.forEach(ev => calendar.addEvent(ev));
        }

        if(searchInput){
            searchInput.addEventListener('input', renderFilteredEvents);
        }
        document.querySelectorAll('#sns-filters input[type=checkbox]').forEach(cb => {
            cb.addEventListener('change', renderFilteredEvents);
        });

        loadAllEvents();
    });
    </script>
</div>
</body>
</html>
